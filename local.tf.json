{
  "locals": {
    "cluster-api-version": "client.authentication.k8s.io/v1beta1",
    "cluster-certificate": "${base64decode(yamldecode(data.oci_containerengine_cluster_kube_config.main.content).clusters.0.cluster[\"certificate-authority-data\"])}",
    "cluster-command-arguments": [
      "ce",
      "cluster",
      "generate-token",
      "--cluster-id",
      "${oci_containerengine_cluster.main.id}"
    ],
    "log-retention-duration": 30,
    "project": "platform",
    "monitor-values": {
      "alertmanager": { "enabled": false },
      "grafana": {
        "enabled": true,
        "priorityClassName": "priority-system",
        "resources": {
          "limits": { "cpu": "200m", "memory": "512Mi" },
          "requests": { "cpu": "100m", "memory": "256Mi" }
        }
      },
      "prometheus": {
        "prometheusSpec": {
          "priorityClassName": "priority-system",
          "resources": {
            "limits": { "cpu": "400m", "memory": "2Gi" },
            "requests": { "cpu": "400m", "memory": "2Gi" }
          },
          "retention": "3d",
          "storageSpec": { "emptyDir": { "medium": "Memory" } }
        }
      },
      "prometheusOperator": {
        "resources": {
          "limits": { "cpu": "100m", "memory": "256Mi" },
          "requests": { "cpu": "50m", "memory": "128Mi" }
        }
      }
    },
    "tailscale-acl": {
      "acls": [{ "action": "accept", "dst": ["*:*"], "src": ["*"] }],
      "autoApprovers": {
        "routes": {
          "${oci_core_subnet.private.cidr_block}": [
            "${local.tailscale-acl-tag}"
          ]
        }
      },
      "ssh": [
        {
          "action": "accept",
          "dst": ["autogroup:self", "${local.tailscale-acl-tag}"],
          "src": ["autogroup:member"],
          "users": ["autogroup:nonroot"]
        }
      ],
      "tagOwners": { "${local.tailscale-acl-tag}": ["autogroup:member"] }
    },
    "tailscale-acl-tag": "tag:bastion",
    "tailscale-user-data": [
      "#!/bin/bash",
      "echo 'net.ipv4.ip_forward = 1' | tee -a /etc/sysctl.d/99-tailscale.conf",
      "echo 'net.ipv6.conf.all.forwarding = 1' | tee -a /etc/sysctl.d/99-tailscale.conf",
      "sysctl -p /etc/sysctl.d/99-tailscale.conf",
      "curl -fsSL https://tailscale.com/install.sh | sh",
      "tailscale up \\",
      "--authkey=${tailscale_tailnet_key.main.key} \\",
      "--hostname=${local.project}-bastion \\",
      "--advertise-routes=${oci_core_subnet.private.cidr_block} \\",
      "--accept-routes \\",
      "--ssh"
    ],
    "controller-set": [
      { "name": "deployment.replicas", "value": 2 },
      { "name": "priorityClassName", "value": "priority-system" },
      {
        "name": "deployment.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution.0.weight",
        "value": 100
      },
      {
        "name": "deployment.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution.0.podAffinityTerm.labelSelector.matchExpressions.0.key",
        "value": "app.kubernetes.io/name"
      },
      {
        "name": "deployment.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution.0.podAffinityTerm.labelSelector.matchExpressions.0.operator",
        "value": "In"
      },
      {
        "name": "deployment.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution.0.podAffinityTerm.labelSelector.matchExpressions.0.values.0",
        "value": "controller"
      },
      {
        "name": "deployment.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution.0.podAffinityTerm.topologyKey",
        "value": "kubernetes.io/hostname"
      }
    ],
    "controller-values": {
      "resources": {
        "limits": { "cpu": "200m", "memory": "512Mi" },
        "requests": { "cpu": "100m", "memory": "256Mi" }
      },
      "service": {
        "annotations": {
          "service.beta.kubernetes.io/oci-load-balancer-internal": "false",
          "service.beta.kubernetes.io/oci-load-balancer-ip-address": "${oci_core_public_ip.main.ip_address}",
          "service.beta.kubernetes.io/oci-load-balancer-id": "${oci_load_balancer_load_balancer.main.id}"
        }
      }
    }
  }
}
