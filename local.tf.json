{
  "locals": {
    "cluster-api-version": "client.authentication.k8s.io/v1beta1",
    "cluster-certificate": "${base64decode(yamldecode(data.oci_containerengine_cluster_kube_config.main.content).clusters.0.cluster[\"certificate-authority-data\"])}",
    "cluster-command-arguments": [
      "ce",
      "cluster",
      "generate-token",
      "--cluster-id",
      "${oci_containerengine_cluster.main.id}"
    ],
    "log-retention-duration": 30,
    "project": "platform",
    "tailscale-acl": {
      "acls": [{ "action": "accept", "dst": ["*:*"], "src": ["*"] }],
      "autoApprovers": {
        "routes": {
          "${oci_core_subnet.private.cidr_block}": [
            "${local.tailscale-acl-tag}"
          ]
        }
      },
      "ssh": [
        {
          "action": "accept",
          "dst": ["autogroup:self", "${local.tailscale-acl-tag}"],
          "src": ["autogroup:member"],
          "users": ["autogroup:nonroot"]
        }
      ],
      "tagOwners": { "${local.tailscale-acl-tag}": ["autogroup:member"] }
    },
    "tailscale-acl-tag": "tag:bastion",
    "tailscale-user-data": [
      "#!/bin/bash",
      "echo 'net.ipv4.ip_forward = 1' | tee -a /etc/sysctl.d/99-tailscale.conf",
      "echo 'net.ipv6.conf.all.forwarding = 1' | tee -a /etc/sysctl.d/99-tailscale.conf",
      "sysctl -p /etc/sysctl.d/99-tailscale.conf",
      "curl -fsSL https://tailscale.com/install.sh | sh",
      "tailscale up \\",
      "--authkey=${tailscale_tailnet_key.main.key} \\",
      "--hostname=${local.project}-bastion \\",
      "--advertise-routes=${oci_core_subnet.private.cidr_block} \\",
      "--accept-routes \\",
      "--ssh"
    ],
    "traefik-values": {
      "service": {
        "annotations": {
          "service.beta.kubernetes.io/oci-load-balancer-internal": "false",
          "service.beta.kubernetes.io/oci-load-balancer-shape": "flexible",
          "service.beta.kubernetes.io/oci-load-balancer-shape-flex-min": "10",
          "service.beta.kubernetes.io/oci-load-balancer-shape-flex-max": "10",
          "service.beta.kubernetes.io/oci-load-balancer-ip-address": "YOUR_RESERVED_PUBLIC_IP"
        }
      },
      "resources": {
        "requests": { "cpu": "100m", "memory": "256Mi" },
        "limits": { "cpu": "200m", "memory": "512Mi" }
      }
    }
  }
}
