{
  "locals": {
    "controller-values": {
      "additionalArguments": [
        "--entryPoints.websecure.forwardedHeaders.trustedIPs=${join(\",\", data.cloudflare_ip_ranges.main.ipv4_cidrs)}",
        "--entryPoints.websecure.proxyProtocol.trustedIPs=${join(\",\", data.cloudflare_ip_ranges.main.ipv4_cidrs)}"
      ],
      "deployment": {
        "podAntiAffinity": {
          "preferredDuringSchedulingIgnoredDuringExecution": [
            {
              "podAffinityTerm": {
                "labelSelector": {
                  "matchExpressions": [
                    {
                      "key": "app.kubernetes.io/name",
                      "operator": "In",
                      "values": ["traefik"]
                    }
                  ]
                },
                "topologyKey": "kubernetes.io/hostname"
              },
              "weight": 100
            }
          ]
        },
        "replicas": 2
      },
      "globalArguments": [
        "--global.checknewversion=false",
        "--global.sendanonymoususage=false"
      ],
      "ports": {
        "web": {
          "redirections": {
            "entryPoint": { "scheme": "https", "to": "websecure" }
          }
        },
        "websecure": { "tls": { "enabled": true } }
      },
      "priorityClassName": "priority-system",
      "resources": {
        "limits": { "cpu": "200m", "memory": "256Mi" },
        "requests": { "cpu": "100m", "memory": "128Mi" }
      },
      "service": {
        "annotations": {
          "service.beta.kubernetes.io/oci-network-load-balancer-display-name": "${local.project}-network-load-balancer",
          "service.beta.kubernetes.io/oci-network-load-balancer-is-preserve-source-destination": "true",
          "service.beta.kubernetes.io/oci-network-load-balancer-reserved-public-ip-id": "${oci_core_public_ip.main.id}",
          "service.beta.kubernetes.io/oci-network-load-balancer-security-groups": "${oci_core_network_security_group.worker.id}",
          "service.beta.kubernetes.io/oci-network-load-balancer-subnet": "${oci_core_subnet.public.id}",
          "service.beta.kubernetes.io/oci-network-load-balancer-type": "nlb"
        },
        "externalTrafficPolicy": "Local",
        "type": "LoadBalancer"
      }
    },
    "domain": "mangocraft.work",
    "log-retention-duration": 30,
    "monitor-values": {
      "alertmanager": { "enabled": false },
      "grafana": {
        "additionalDataSources": [
          {
            "access": "proxy",
            "isDefault": true,
            "name": "Prometheus",
            "type": "prometheus",
            "url": "http://monitor-kube-prometheus-stack-prometheus.system:9090"
          }
        ],
        "adminPassword": "${var.monitor_password}",
        "persistence": { "enabled": false },
        "resources": {
          "limits": { "cpu": "150m", "memory": "512Mi" },
          "requests": { "cpu": "100m", "memory": "256Mi" }
        }
      },
      "kube-state-metrics": {
        "resources": {
          "limits": { "cpu": "100m", "memory": "128Mi" },
          "requests": { "cpu": "50m", "memory": "64Mi" }
        }
      },
      "kubeControllerManager": { "enabled": false },
      "kubeProxy": { "enabled": false },
      "kubeScheduler": { "enabled": false },
      "kubeStateMetrics": { "enabled": true },
      "nodeExporter": {
        "resources": {
          "limits": { "cpu": "50m", "memory": "128Mi" },
          "requests": { "cpu": "20m", "memory": "64Mi" }
        }
      },
      "prometheus": {
        "prometheusSpec": {
          "configReloaderResources": {
            "limits": { "cpu": "50m", "memory": "64Mi" },
            "requests": { "cpu": "20m", "memory": "32Mi" }
          },
          "priorityClassName": "priority-system",
          "resources": {
            "limits": { "cpu": "300m", "memory": "800Mi" },
            "requests": { "cpu": "100m", "memory": "512Mi" }
          },
          "retention": "1d",
          "storageSpec": { "emptyDir": { "medium": "Memory" } }
        }
      },
      "prometheusOperator": {
        "resources": {
          "limits": { "cpu": "100m", "memory": "256Mi" },
          "requests": { "cpu": "50m", "memory": "128Mi" }
        }
      }
    },
    "project": "platform",
    "tailscale-acl": {
      "acls": [{ "action": "accept", "dst": ["*:*"], "src": ["*"] }],
      "autoApprovers": {
        "routes": {
          "${oci_core_subnet.private.cidr_block}": [
            "${local.tailscale-acl-tag}"
          ]
        }
      },
      "ssh": [
        {
          "action": "accept",
          "dst": ["autogroup:self", "${local.tailscale-acl-tag}"],
          "src": ["autogroup:member"],
          "users": ["autogroup:nonroot"]
        }
      ],
      "tagOwners": { "${local.tailscale-acl-tag}": ["autogroup:member"] }
    },
    "tailscale-acl-tag": "tag:bastion",
    "tailscale-user-data": [
      "#!/bin/bash",
      "echo 'net.ipv4.ip_forward = 1' | tee -a /etc/sysctl.d/99-tailscale.conf",
      "echo 'net.ipv6.conf.all.forwarding = 1' | tee -a /etc/sysctl.d/99-tailscale.conf",
      "sysctl -p /etc/sysctl.d/99-tailscale.conf",
      "curl -fsSL https://tailscale.com/install.sh | sh",
      "tailscale up \\",
      "--authkey=${tailscale_tailnet_key.main.key} \\",
      "--hostname=${local.project}-bastion \\",
      "--advertise-routes=${oci_core_subnet.private.cidr_block} \\",
      "--accept-routes \\",
      "--ssh"
    ]
  }
}
