{
  "locals": {
    "controller-values": {
      "additionalArguments": [
        "--entryPoints.websecure.forwardedHeaders.trustedIPs=${join(\",\", data.cloudflare_ip_ranges.main.ipv4_cidrs)}"
      ],
      "deployment": {
        "podAntiAffinity": {
          "preferredDuringSchedulingIgnoredDuringExecution": [
            {
              "podAffinityTerm": {
                "labelSelector": {
                  "matchExpressions": [
                    {
                      "key": "app.kubernetes.io/name",
                      "operator": "In",
                      "values": ["traefik"]
                    }
                  ]
                },
                "topologyKey": "kubernetes.io/hostname"
              },
              "weight": 100
            }
          ]
        },
        "replicas": 2
      },
      "globalArguments": [
        "--global.checknewversion=false",
        "--global.sendanonymoususage=false"
      ],
      "ports": {
        "web": {
          "redirections": {
            "entryPoint": { "scheme": "https", "to": "websecure" }
          }
        },
        "websecure": { "tls": { "enabled": true } }
      },
      "priorityClassName": "priority-system",
      "resources": {
        "limits": { "cpu": "200m", "memory": "256Mi" },
        "requests": { "cpu": "100m", "memory": "128Mi" }
      },
      "service": {
        "annotations": {
          "oci-network-load-balancer.oraclecloud.com/is-private": "false",
          "oci-network-load-balancer.oraclecloud.com/oci-network-security-groups": "${oci_core_network_security_group.worker.id}",
          "oci-network-load-balancer.oraclecloud.com/subnet": "${oci_core_subnet.public.id}",
          "oci.oraclecloud.com/load-balancer-type": "nlb",
          "oci.oraclecloud.com/reserved-ips": "${oci_core_public_ip.main.ip_address}"
        }
      }
    },
    "dashboard-values": {
      "extraArgs": [
        "--admin-password",
        "${bcrypt(var.password)}",
        "--host",
        "0.0.0.0"
      ],
      "image": {
        "pullPolicy": "Always",
        "repository": "docker.io/portainer/portainer-ce",
        "tag": "latest"
      },
      "ingress": { "enabled": false },
      "persistence": { "enabled": false },
      "resources": {
        "limits": { "cpu": "200m", "memory": "256Mi" },
        "requests": { "cpu": "100m", "memory": "128Mi" }
      },
      "service": { "type": "ClusterIP" }
    },
    "domain": "mangocraft.work",
    "log-retention-duration": 30,
    "metrics-values": { "args": ["--kubelet-insecure-tls"] },
    "project": "platform",
    "tailscale-acl": {
      "acls": [{ "action": "accept", "dst": ["*:*"], "src": ["*"] }],
      "autoApprovers": {
        "routes": {
          "${oci_core_subnet.private.cidr_block}": [
            "${local.tailscale-acl-tag}"
          ]
        }
      },
      "ssh": [
        {
          "action": "accept",
          "dst": ["autogroup:self", "${local.tailscale-acl-tag}"],
          "src": ["autogroup:member"],
          "users": ["autogroup:nonroot"]
        }
      ],
      "tagOwners": { "${local.tailscale-acl-tag}": ["autogroup:member"] }
    },
    "tailscale-acl-tag": "tag:bastion",
    "tailscale-user-data": [
      "#!/bin/bash",
      "echo 'net.ipv4.ip_forward = 1' | tee -a /etc/sysctl.d/99-tailscale.conf",
      "echo 'net.ipv6.conf.all.forwarding = 1' | tee -a /etc/sysctl.d/99-tailscale.conf",
      "sysctl -p /etc/sysctl.d/99-tailscale.conf",
      "curl -fsSL https://tailscale.com/install.sh | sh",
      "tailscale up \\",
      "--authkey=${tailscale_tailnet_key.main.key} \\",
      "--hostname=${local.project}-bastion \\",
      "--advertise-routes=${oci_core_subnet.private.cidr_block} \\",
      "--accept-routes \\",
      "--ssh"
    ]
  }
}
